---
title: "Transparency in Science"
subtitle: "Principled Approaches to Computational Reproducibility and Preregistration"
author: 
  - "Aaron Peikert"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    seal: false
    css: xaringan-themer.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
repro:
  packages:
    - xaringanthemer
    - showtext
    - svglite
    - patchwork
    - here
    - qrcode
---
class: center, middle
name: qrcode

```{r setup, include=FALSE}
library(xaringanthemer)
library(tidyverse)
library(patchwork)
library(qrcode)
options(htmltools.dir.version = FALSE)
knitr::read_chunk("R/plots.R")
knitr::opts_chunk$set(
  fig.width=9, fig.height=4, fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  dev = "svglite"
)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
primary_color <- "#024959"
secondary_color <- "#F28705"
style_duo(
  primary_color = primary_color,
  secondary_color = secondary_color,
  header_font_google = google_font("Didact Gothic", "400", "400i"),
  text_font_google   = google_font("IBM Plex Sans", "400", "400i"),
  text_font_size = "1.5rem",
  extra_fonts = list(google_font("Parisienne", "400", "400i"))
  )

style_extra_css(css = list(".todo" = list(color = "#17C25B"),
                           ".optional" = list(color = "#05BCE6"),
                           ".large" = list(`font-size` = "130%"),
                           ".small" = list(`font-size` = "80%"),
                           ".enormous" = list(`font-size` = "1000%"),
                           ".full" = list(padding = "0px",
                                          margin = "0px",
                                          border = "0px"),
                           ".vertical" = list(`writing-mode` = "vertical-rl",
                                              `text-orientation` = "mixed"),
                           ".blurry" = list(color = "transparent",
                                            `text-shadow` = "0 0 5px rgba(0,0,0,0.5)"),
                           ".blurry2" = list(filter = "blur(2px)",
                                             `-webkit-filter` = "blur(2px)"),
                           ".curly" = list("font-family" = "Parisienne"),
                           ".white" = list(color = "#FFFFFF")
                    )
                )
```

```{r, echo=FALSE}
link <- "github.com/aaronpeikert/bayes-prereg"
```

```{r, echo=FALSE, out.width = "30%"}
fs::dir_create("images")
generate_svg(qr_code(link), here::here("images/", "qr_slides.svg"), foreground = secondary_color, background = primary_color, show = FALSE)
knitr::include_graphics("images/qr_slides.svg")
```

`r link`

.pull-right[![CC0](https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg)]

---
class: center, middle

# Transparency in Science

## Principled Approaches to Computational Reproducibility and Preregistration

### Aaron Peikert

### LCBC Berlin  | 22.11.2022

---
class: inverse, center, middle

# Trust in Science

---
class: center, middle

.enormous[?]

---

```{r, echo=FALSE}
crisis <- tribble(
  ~response, ~bin, ~prop,
  "Yes, a signicant crisis", "YES", .52,
  "Yes, a slight crisis", "YES", .38,
  "No, there is no crisis", "NO", .03,
  "Don‚Äôt know", "NA", 0.07
)

crisis_plot <- crisis %>%
  group_by(bin) %>%
  summarise(prop = sum(prop)) %>%
  ungroup() %>% 
  ggplot(aes(
    "response",
    prop,
    fill = bin,
    label = bin,
    size = prop
  )) +
  geom_col() +
  geom_text(position = position_stack(vjust = 0.5)) +
  coord_flip() +
  theme_void() +
  theme(
    legend.position = "none",
    panel.background = element_rect(fill = "transparent", colour = NA),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  scale_y_continuous(expand=c(0,0)) +
  scale_x_discrete(expand=c(0,0), limits = NULL) +
  scale_fill_manual(values = c("YES" = "#E3350E", "NO" = "#F28705", "NA" = "lightgrey")) +
  scale_size_continuous(range = c(4, 20)) +
  NULL
```

## Is there a replication crisis?*

.center[

```{r, out.width = '70%'}
crisis_plot /
  (crisis_plot +
     aes(label = str_c(prop * 100, "%")) + 
     scale_size_continuous(range = c(3, 12))) + 
  plot_layout(heights = c(.7, .3)) + 
  plot_annotation(theme = theme_void() + theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    plot.background = element_rect(fill = "transparent", colour = NA)
))

```
]

.small.right[Baker, M. 1,500 scientists lift the lid on reproducibility. *Nature* 533, 452‚Äì454 (2016). https://doi.org/10.1038/533452a]

--

.small.right[***They call it "reproducibility" and fail to publish the raw data.**]

---
class: inverse, center, middle

# Transparency in Science*

*Statisticians' Edition

---
class: center, middle

# World ‚Üí Theory

---
class: center, middle

# World ‚Üê Theory

---
class: center, middle

# World ‚Üî Theory

--

.curly.white.large[It's a match!]

---
class: center, middle, inverse

# Principled Approach

---
class: center, middle

# $L(\text{Theory}, \text{Data})$

---
class: center, middle

# —¥Œ±–Øi‚Ç¨ùúèy

### $L(\text{Theory}, \text{Data})$

---
class: center, middle

$$L_1(\text{Theory}, \text{Data})$$
$$\vdots$$
$$L_\infty(\text{Theory}, \text{Data})$$

---
class: center, middle, inverse

# Statistical Models

--

= automated induction

---
class: center, middle

# Theory

---
class: center, middle

# T‚ñàe‚ñàry

---
class: middle

$$Model(\text{Theory})$$
---
class: middle

$$Model(\text{Theory}, \text{Data})$$

---

### How statisticians judge a model:

Sampling the world and compare:

$$
L(\text{Model}(\text{Data}), \text{Data}) + \mathcal{C}(\text{Model})
$$
e.g.: Adjusted R¬≤, Stein's Unbiased Risk Estimator, Information Criteria, etc.

.center[

**We account for peeking at the data**

]

---

### Researcher have a harder job:

Sampling the world and compare:

$$
L(\text{Model}(\text{Data}), \text{Data}) + \mathcal{C}(\text{Model}) + \mathcal{C}(\text{Human})
$$
.center[

**We must account for the models and humans ability to make sense of any data.**

]

---
class: center, middle

.left[What happens if]

.center[

$\mathcal{C}(\text{Model})$ or $\mathcal{C}(\text{Human})$

]

.right[is unknown?]

---
class: center, middle, inverse

# .blurry[Uncertainty]

---

The goal:

.center[

$L(\text{Model}(\text{Data}), \text{Data}) + \mathcal{C}(\text{Model}) + \mathcal{C}(\text{Human})$

]

--

The enemy:

.pull-left[

.blurry2[$$\mathcal{C}(\text{Model})$$]

]

.pull-right[

.blurry2[$$\mathcal{C}(\text{Human})$$]

]

--

The solution:

.pull-left.center[

### Computational Reproducibility

]

.pull-right.center[

### Preregistration

]

---

.pull-left.center[

### Computational Reproducibility

Conceptually trivial

]

.pull-right.center[

### Preregistration

Conceptually difficult

]

--

.pull-left.center[

technologically difficult

low social hurdles

]

.pull-right.center[

technologically trivial

high social hurdles

]

---

.pull-left.center[

### Computational Reproducibility

Conceptually trivial üòÄ

technologically difficult üòí

low social hurdles üòÄ

]

.pull-right.center[

### Preregistration

Conceptually difficult üòí

technologically trivial üòÄ

high social hurdles üòí

]

--

Reducing uncertainty about:

.center[

$\mathcal{C}(\text{Model})$ &emsp; vs &emsp; $\mathcal{C}(\text{Human})$

]

---
class: center, middle, inverse

# Computational Reproducibility

---
class: center, middle

‚ÄúInsanity is doing the same thing over and over again and expecting different results.‚Äù

.right[‚ÄîAlbert Einstein (disputed)]

--

As it turns out, doing the **same** thing is pretty complicated.

---
class: middle

1. Multiple inconsistent versions of code and data
--

2. Copy-and-paste errors
--

3. Ambiguous order of code execution
--

4. Broken dependencies

---
class: center, middle

| Problem       | Solution            | Implementation    |
|---------------|---------------------|-------------------|
| versions?     | version control     | Git               |
| copy&paste?   | dynamic documents   | R Markdown        |
| order?        | workflow automation | Make / GH Actions |
| dependencies? | software management | Docker            |

---
class: center, middle
background-color: white

```{r, out.width='80%'}
knitr::include_graphics("https://raw.githubusercontent.com/aaronpeikert/repro-tutorial/main/images/nutshell.svg")
```


---
class: center, middle

.small[<https://github.com/aaronpeikert/repro-talk/releases/download/marbach/repro-talk.pdf>]

---
class: center, middle, inverse

# Preregistration

---

## Is there a replication crisis?*

.center[

```{r, out.width = '70%'}
crisis_plot /
  (crisis_plot +
     aes(label = str_c(prop * 100, "%")) + 
     scale_size_continuous(range = c(3, 12))) + 
  plot_layout(heights = c(.7, .3)) + 
  plot_annotation(theme = theme_void() + theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    plot.background = element_rect(fill = "transparent", colour = NA)
))
```
]

.small.right[Baker, M. 1,500 scientists lift the lid on reproducibility. *Nature* 533, 452‚Äì454 (2016). https://doi.org/10.1038/533452a]

---
class: center, middle
layout: true

---

## Because researchers are *fraudsters*?

--

# No

???
Some say to prevent intentional wrongdoing. 
However, preregistrations are easily circumvented with bad intentions.
We must assume researchers have good intentions.
---

## Because researchers are *fools*?

--

# No
--
, not necessarily

???
Some say to prevent unintentional wrongdoing.
Researchers must be put in restrains to prevent them from cutting themselves on the sharp edge of "false positives".

---
layout: false
class: inverse, center, middle

# Traditional view

---
class: center

# Researchers confuse:

.pull-left.center[

# confirmatory

]
.pull-right.center[

# exploratory

]
---
class: center

# Preregistration separates:

.pull-left.center[

# confirmatory

]
.pull-right.center[

# exploratory

]
--
.pull-left.center[

# ‚âà
# preregistered

]
.pull-right.center[

# ‚âà
# not preregistered

]

--

# ?

---
class: inverse, center, middle

# A Formal Objective

---
class: middle

.large[
Ideally:
1. The original author has **good intentions**.
2. Their readers are **rational**.
3. The goal is to **convince** the readers.
]

---

### Adjusting for complexity in simple models

Adjusted R¬≤, Stein's Unbiased Risk Estimator, Information Criteria, etc.

$$L(\text{Model}(\text{Data}), \text{Data})  + \mathcal{C}(\text{Model})$$

--

### Alternatively:

The statistical complexity of some models is hard to estimate.

Find a situation, were $\mathcal{C}(\text{Model}) = 0$

---
## Test-set (cross validation)

$\mathcal{C}(\text{Model}) = 0$

$$
L(\text{Model}(\text{Train, Test}), \text{Test})
$$
.center[

**There is no peeking to account for.**

]

---
## $\mathcal{C}(\text{Human})$

The statistical complexity of humans is hard to estimate.

Find a situation, were $\mathcal{C}(\text{Human}) = 0$

--

.center[

# Preregistration

]

---
class: center, middle, inverse

# .blurry[Uncertainty]

---
# Statistical Relevancy

Any:

$$L(\text{Theory}, \text{Data})$$

Must benefit from:

$$P(E|H) \gg P(E|¬¨H)$$

---
class: center, middle, inverse

# Bayes*

*my favoritey $L(\text{Theory}, \text{Data})$

---
class: middle

.large[


$$\frac{P(H)P(E|H)}{P(E)}$$
]

--

.left[Law of total probability:]



$$P(E) = P(H)P(E|H) + P(¬¨H)\color{#F28705}{P(E|¬¨H)}$$

---
class: center, middle

## $1 - P(E|¬¨H)$
## =
## $P(¬¨E|¬¨H)$
## =
## Theorethical Risk

---
class: center, middle

## $\mathcal{C}(\text{Model})$ ‚Üí Theorethical Risk ‚Üê $\mathcal{C}(\text{Human})$

---
class: center, middle, inverse

# .blurry[Uncertainty]

---
class: center, middle
name: theoretical-risk-plot2

```{r}
results <- readr::read_rds(here::here("data", "simulation.rds")) 
```

```{r measure-plots}
# see R/plots.R
```

```{r}
plots[["Posterior Probability"]] +
  xaringanthemer::theme_xaringan() +
    theme(legend.position = c(.2, .8),
        legend.title = element_blank(),
        text = element_text(size = 18, color = secondary_color),
        title = element_blank(),
        axis.title = element_text(size = 18),
        plot.caption = element_text(size = 15)) +
  labs(x = "Theoretical Risk",
       y = "Posterior Probability",
       caption = "P(E|H) = .8, P(H) = .1") +
  NULL
```


---
class: center, middle
layout: true
---

.large[**Preregistrations**] reduce .large[**uncertainty**] about .large[**theoretical risk**].

---

### One further idea

---

# Preregistration as Code

### version control + dynamic documents

---
class: center

.pull-left[

### Standard Preregistration

hunches

‚Üì

preregistration

‚Üì

data

‚Üì

article draft
]

.pull-right[

### Preregistration as Code

simulated data

‚Üì

article draft with mock results

‚Üì

data

‚Üì

article draft with real results

]


---

# Can I explore the data?

--

# Yes.

---
template: theoretical-risk-plot2

---

# Can I deviate?

--

# Sometimes.

---
template: theoretical-risk-plot2

---

# How much detail?

--

# Very detailed.

---
template: theoretical-risk-plot2

---
template: qrcode
